---
status: done
priority: p1
issue_id: "005"
tags: [migrations, alembic, database, safety]
dependencies: []
---

# Alembic Missing include_object Filter

## Problem Statement
Alembic's `env.py` lacks an `include_object` filter. Running autogenerate for a tenant schema could erroneously generate `DROP TABLE` statements for public tables (Users, Tenants) because they don't exist in the tenant schema. This could cause catastrophic data loss.

## Findings
- `src/alembic/env.py`: No `include_object` callback defined
- Each migration manually checks `context.get_tag_argument()` to decide whether to run
- Developer error in a new migration could affect wrong schema
- Autogenerate is especially dangerous without filtering

**Risk Scenario:**
```
1. Developer runs: alembic -x schema=tenant_acme revision --autogenerate
2. Alembic compares tenant_acme schema against all SQLModel metadata
3. Public tables (users, tenants) don't exist in tenant_acme
4. Alembic generates: DROP TABLE users; DROP TABLE tenants;
5. Developer reviews quickly, applies migration
6. Public tables destroyed across ALL tenants
```

## Proposed Solutions

### Option 1: Add include_object Filter (Recommended)
- **Pros**: Automatic protection, no reliance on developer discipline
- **Cons**: None - this is standard Alembic best practice
- **Effort**: Small
- **Risk**: Low

**Implementation:**
```python
# src/alembic/env.py

def include_object(object, name, type_, reflected, compare_to):
    """
    Filter objects to prevent cross-schema contamination.
    - Public migrations: only touch tables with schema='public'
    - Tenant migrations: only touch tables WITHOUT schema='public'
    """
    if type_ == "table":
        is_tenant_migration = context.get_tag_argument() is not None
        object_schema = getattr(object, 'schema', None)

        if is_tenant_migration:
            # Tenant migrations should ONLY touch tables WITHOUT 'public' schema
            return object_schema != "public"
        else:
            # Public migrations should ONLY touch tables WITH 'public' schema
            return object_schema == "public"

    return True

def do_run_migrations(connection, schema: str | None = None) -> None:
    # ... existing schema setup ...

    context.configure(
        connection=connection,
        target_metadata=target_metadata,
        version_table_schema=schema,
        include_schemas=True,
        include_object=include_object,  # <--- CRITICAL FIX
    )
    # ...
```

## Recommended Action
Add `include_object` hook to filter tables by schema during migration generation and execution.

## Technical Details
- **Affected Files**:
  - `src/alembic/env.py`
- **Related Components**: All database migrations
- **Database Changes**: No (prevents unintended changes)

## Resources
- Original finding: Code Review - "Migration Hazard"
- Alembic docs: https://alembic.sqlalchemy.org/en/latest/autogenerate.html#controlling-what-to-be-autogenerated
- Related issues: None

## Acceptance Criteria
- [ ] `include_object()` function added to env.py
- [ ] Public migrations only affect public schema tables
- [ ] Tenant migrations only affect tenant schema tables
- [ ] Autogenerate tested for both scenarios
- [ ] Tests pass
- [ ] Code reviewed

## Work Log

### 2025-12-16 - Initial Discovery
**By:** Claude Triage System
**Actions:**
- Issue discovered during code review analysis
- Categorized as P1 High (data loss risk)
- Estimated effort: Small

**Learnings:**
- Multi-tenant Alembic setups need include_object filtering
- Autogenerate without filtering is dangerous in multi-schema environments
- Schema attribute on tables is key for filtering

## Notes
Source: Code review analysis on 2025-12-16
